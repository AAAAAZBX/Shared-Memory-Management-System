# Shared Memory Management System

## 项目简介

本项目是一个基于 C++17 实现的共享内存管理系统，采用固定块大小（4KB）的内存池管理策略，提供高效的内存分配、释放和紧凑功能。目前已完成服务器端核心功能的开发与测试。

## 核心特性

### 内存管理
- **固定块大小管理**：将内存池划分为 256 个 4KB 的固定大小块（当前配置为 1MB 内存池）
- **连续块分配**：支持跨多个块的数据存储，自动计算所需块数
- **内存紧凑（Compaction）**：当找不到连续空闲块但总空间足够时，自动进行内存紧凑，合并碎片
- **元数据管理**：每个块维护使用状态、用户标识和内容标识

### 已实现功能

#### 1. 内存池初始化与重置
- 自动分配 1MB 连续内存空间
- 支持内存池重置，清空所有分配信息

#### 2. 内存分配（`alloc`）
- 支持按用户和内容标识分配内存
- 自动计算所需块数（向上取整）
- 空间不足时自动触发紧凑操作
- 返回分配的起始块 ID

#### 3. 内存释放
- `FreeByUser`：释放指定用户的所有内存块
- `FreeByBlockId`：释放指定块 ID 的内存

#### 4. 内存紧凑（`compact`）
- 自动合并碎片，将已使用的块移动到内存池前端
- 更新用户块信息映射关系

#### 5. 状态查询（`status`）
- `status --memory`：显示内存池使用情况，按用户展示占用范围
- `status --block`：显示所有 256 个块的状态，包括占用客户端信息

#### 6. 命令行界面
- 交互式 REPL（Read-Eval-Print Loop）界面
- 完整的帮助系统（`help` 命令）
- 优雅的退出机制（`quit` / `exit`）

## 技术架构

### 核心类设计

#### `SharedMemoryPool`
内存池管理核心类，负责：
- 内存块的分配与释放
- 元数据维护（`BlockMeta`）
- 空闲块追踪（`bitset`）
- 用户分配信息映射（`map<string, pair<size_t, size_t>>`）

#### 关键数据结构
```cpp
struct BlockMeta {
    bool used;           // 是否被使用
    std::string user;    // 用户标识（IP:端口号）
    std::string content; // 内容标识
};
```

### 内存布局
```
┌─────────────────────────────────────────┐
│  Memory Pool (1MB = 256 × 4KB blocks)  │
├─────────────────────────────────────────┤
│ Block 0   │ Block 1   │ ... │ Block 255 │
│ (4KB)     │ (4KB)     │     │ (4KB)     │
└─────────────────────────────────────────┘
```

## 使用方法

### 编译与运行

#### 方式一：使用批处理脚本（推荐）
```bash
cd server
.\run.bat
```

#### 方式二：手动编译
```bash
cd server
g++ -std=c++17 -Wall main.cpp commands.cpp shared_memory_pool.cpp -o main.exe
.\main.exe
```

### 命令示例

```bash
# 查看帮助
server> help
server> help status

# 查看内存状态
server> status --memory
server> status --block

# 分配内存（当前已注释，待 TCP 功能实现后启用）
# server> alloc client_1 "Hello World"

# 紧凑内存
server> compact

# 退出
server> quit
```

### 状态输出示例

**`status --memory` 输出：**
```
Memory Pool Status:
| range   | Occupied Client     |
| ------- | ------------------- |
| 0 - 15  | 192.168.1.100:54321 |
| 16 - 31 | client_2            |
```

**`status --block` 输出：**
```
Block Pool Status:
| ID        | Occupied Client     |
| --------- | ------------------- |
| block_000 | 192.168.1.100:54321 |
| block_001 | 192.168.1.100:54321 |
| block_002 | -                   |
```

## 项目结构

```
Shared-Memory-Manage-System/
├── server/
│   ├── main.cpp                 # 主程序入口，REPL 循环
│   ├── shared_memory_pool.h     # 内存池类声明
│   ├── shared_memory_pool.cpp   # 内存池实现
│   ├── commands.h               # 命令处理声明
│   ├── commands.cpp             # 命令处理实现
│   ├── run.bat                  # 编译运行脚本
│   └── build.bat                # 编译脚本
├── details.md                   # 项目需求文档
└── README.md                    # 本文件
```

## 技术栈

- **语言**：C++17
- **编译器**：g++ (MinGW-w64 / MSYS2)
- **标准库**：STL（`vector`, `map`, `bitset`, `array`）
- **平台**：Windows

## 代码质量

- ✅ 遵循 C++17 标准
- ✅ 使用现代 C++ 特性（`constexpr`, `auto`, 范围 for 循环）
- ✅ 内存安全（使用 STL 容器，避免裸指针）
- ✅ 错误处理（返回值检查，异常安全）
- ✅ 代码格式化（clang-format，K&R 风格）

## 待实现功能

### 短期目标
- [ ] TCP 服务器功能（监听端口，接受客户端连接）
- [ ] 客户端程序（`client.exe`）
- [ ] 网络协议实现（请求/响应格式）
- [ ] 数据持久化（服务器关闭时保存状态，启动时恢复）

### 长期目标
- [ ] 支持多客户端并发访问
- [ ] 内存池大小可配置（当前固定 1MB）
- [ ] 性能优化（减少内存拷贝，优化紧凑算法）
- [ ] 日志系统
- [ ] 单元测试

## 开发进度

| 功能模块   | 状态     | 完成度 |
| ---------- | -------- | ------ |
| 内存池核心 | ✅ 完成   | 100%   |
| 内存分配   | ✅ 完成   | 100%   |
| 内存释放   | ✅ 完成   | 100%   |
| 内存紧凑   | ✅ 完成   | 100%   |
| 命令行界面 | ✅ 完成   | 100%   |
| 状态查询   | ✅ 完成   | 100%   |
| TCP 服务器 | ⏳ 待实现 | 0%     |
| 客户端程序 | ⏳ 待实现 | 0%     |
| 数据持久化 | ⏳ 待实现 | 0%     |

## 性能指标

- **内存池大小**：1MB（256 × 4KB 块）
- **分配算法**：首次适配（First Fit）+ 自动紧凑
- **时间复杂度**：
  - 分配：O(n) 最坏情况，n 为块数
  - 紧凑：O(n)
  - 释放：O(1)

## 注意事项

1. 当前版本为服务器端核心功能实现，TCP 网络功能尚未集成
2. `alloc` 命令已实现但当前被注释，等待网络功能完成后启用
3. 内存池大小可在 `shared_memory_pool.h` 中通过 `kPoolSize` 常量调整
4. 建议使用支持 C++17 的编译器（g++ 7.0+ 或 MSVC 2017+）

## 作者

[您的姓名/团队]

## 更新日志

### v0.1.0 (当前版本)
- ✅ 实现内存池核心功能
- ✅ 实现内存分配、释放、紧凑
- ✅ 实现命令行界面和状态查询
- ✅ 完成代码重构和错误修复
- ✅ 通过编译和基本功能测试

---

**项目状态**：核心功能已完成，可正常运行 ✅
